<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Catalog | My Bookstore</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="catalog-page">

<div th:replace="~{fragments/navbar :: header}"></div>

<header class="catalog-header text-center">
  <div class="container">
    <h1 class="display-4 fw-bold"><i class="bi bi-book-half me-2"></i>Book Catalog</h1>
    <p class="lead">Explore our collection of stories and knowledge</p>
  </div>
</header>

<main class="container py-5">
  <div class="glass-card">
    <form th:action="@{/books}" th:object="${bookFilter}" method="get" class="row g-3">
      <div class="col-12">
        <div class="input-group input-group-lg shadow-sm">
          <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
          <input type="text" th:field="*{searchQuery}" class="form-control border-start-0"
                 placeholder="Search by name, author, or description..."
                 onkeydown="if(event.key === 'Enter'){this.form.submit();}">
        </div>
      </div>

      <div class="col-md-3 filter-section">
        <label>Author</label>
        <input type="text" th:field="*{author}" class="form-control shadow-sm" placeholder="Author name">
      </div>
      <div class="col-md-3 filter-section">
        <label>Genre</label>
        <input type="text" th:field="*{genre}" class="form-control shadow-sm" placeholder="e.g. Fantasy">
      </div>
      <div class="col-md-3 filter-section">
        <label>Age Group</label>
        <select th:field="*{ageGroup}" class="form-select shadow-sm">
          <option value="">All Ages</option>
          <option th:each="age : ${ageGroups}" th:value="${age}" th:text="${age}"></option>
        </select>
      </div>
      <div class="col-md-3 filter-section">
        <label>Sort By</label>
        <select name="sort" class="form-select shadow-sm" onchange="this.form.submit()">
          <option value="name,asc" th:selected="${param.sort != null && param.sort[0] == 'name,asc'}">Name (A-Z)</option>
          <option value="name,desc" th:selected="${param.sort != null && param.sort[0] == 'name,desc'}">Name (Z-A)</option>
          <option value="price,asc" th:selected="${param.sort != null && param.sort[0] == 'price,asc'}">Price (Low-High)</option>
          <option value="price,desc" th:selected="${param.sort != null && param.sort[0] == 'price,desc'}">Price (High-Low)</option>
        </select>
      </div>

      <div class="col-md-6 d-flex gap-2">
        <div class="w-50 filter-section">
          <label>Price Range</label>
          <div class="input-group input-group-sm">
            <input type="number" step="0.01" th:field="*{minPrice}" class="form-control" placeholder="Min">
            <input type="number" step="0.01" th:field="*{maxPrice}" class="form-control" placeholder="Max">
          </div>
        </div>
        <div class="w-50 filter-section">
          <label>Publication Period</label>
          <div class="input-group input-group-sm">
            <input type="date" th:name="startPublicationDate" th:value="${bookFilter.startPublicationDate}" class="form-control">
            <input type="date" th:name="endPublicationDate" th:value="${bookFilter.endPublicationDate}" class="form-control">
          </div>
        </div>
      </div>

      <div class="col-md-6 filter-section">
        <label class="d-block mb-2">Languages</label>
        <div class="d-flex flex-wrap gap-3">
          <div class="form-check" th:each="lang : ${languages}">
            <input class="form-check-input" type="checkbox" th:field="*{languages}" th:value="${lang}" th:id="'lang-'+${lang}">
            <label class="form-check-label" th:for="'lang-'+${lang}" th:text="${lang}"></label>
          </div>
        </div>
      </div>

      <div class="col-12 mt-4 text-center">
        <button type="submit" class="btn btn-primary px-5 rounded-pill shadow">Apply Filters</button>
        <a th:href="@{/books}" class="btn btn-link text-decoration-none ms-3">Clear All</a>
      </div>
    </form>
  </div>

  <div class="glass-card">
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
        <tr>
          <th>Name</th>
          <th>Author</th>
          <th>Price</th>
          <th>Language</th>
          <th sec:authorize="hasRole('CLIENT')" class="text-center">Purchase</th>
          <th sec:authorize="hasAnyRole('EMPLOYEE', 'ADMIN')" class="text-end">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="book : ${bookPage.content}">
          <td><strong th:text="${book.name}" class="text-dark"></strong></td>
          <td th:text="${book.author}" class="text-muted"></td>
          <td><span class="badge bg-light text-dark shadow-sm px-3" th:text="${'$' + book.price}"></span></td>
          <td><span class="text-uppercase small fw-bold" th:text="${book.language}"></span></td>

          <td sec:authorize="hasRole('CLIENT')" class="text-center">
            <span th:if="${book.inCart}" class="badge rounded-pill bg-success p-2 px-3">
                <i class="bi bi-cart-check-fill me-1"></i> In Cart
            </span>
            <button th:unless="${book.inCart}"
                    class="btn btn-outline-primary btn-sm rounded-pill px-4 add-to-cart-btn"
                    th:data-uuid="${book.publicId}">
              Add to Cart
            </button>
          </td>

          <td sec:authorize="hasAnyRole('EMPLOYEE', 'ADMIN')" class="text-end">
            <div class="btn-group gap-2">
              <a th:href="@{/books/{uuid}/update(uuid=${book.publicId})}" class="btn btn-sm btn-light border">
                <i class="bi bi-pencil"></i>
              </a>
              <form th:action="@{/books/{uuid}/delete(uuid=${book.publicId})}" th:method="post" class="d-inline">
                <input type="hidden" name="page" th:value="${bookPage.number}"/>
                <input type="hidden" name="size" th:value="${bookPage.size}"/>
                <input type="hidden" name="sort" th:value="${param.sort}"/>

                <input type="hidden" name="searchQuery" th:value="${bookFilter.searchQuery}"/>
                <input type="hidden" name="author" th:value="${bookFilter.author}"/>
                <input type="hidden" name="genre" th:value="${bookFilter.genre}"/>
                <input type="hidden" name="ageGroup" th:value="${bookFilter.ageGroup}"/>
                <input type="hidden" name="minPrice" th:value="${bookFilter.minPrice}"/>
                <input type="hidden" name="maxPrice" th:value="${bookFilter.maxPrice}"/>
                <input type="hidden" name="startPublicationDate" th:value="${bookFilter.startPublicationDate}"/>
                <input type="hidden" name="endPublicationDate" th:value="${bookFilter.endPublicationDate}"/>

                <th:block th:each="lang : ${bookFilter.languages}">
                  <input type="hidden" name="languages" th:value="${lang}"/>
                </th:block>

                <button type="submit" class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Are you sure you want to delete this book?')">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <nav th:if="${totalPages > 1}" class="mt-4">
      <ul class="pagination justify-content-center">
        <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
            class="page-item" th:classappend="${currentPage == i} ? 'active'">
          <a class="page-link shadow-sm"
             th:href="@{/books(
            page=${i},
            searchQuery=${bookFilter.searchQuery},
            author=${bookFilter.author},
            genre=${bookFilter.genre},
            ageGroup=${bookFilter.ageGroup},
            minPrice=${bookFilter.minPrice},
            maxPrice=${bookFilter.maxPrice},
            startPublicationDate=${bookFilter.startPublicationDate},
            endPublicationDate=${bookFilter.endPublicationDate},
            languages=${bookFilter.languages},
            sort=${param.sort}
          )}"
             th:text="${i + 1}"></a>
        </li>
      </ul>
    </nav>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/catalog.js}"></script>

</body>
</html>