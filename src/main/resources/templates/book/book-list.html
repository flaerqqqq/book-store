<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Catalog | My Bookstore</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="catalog-page">

<div th:replace="~{fragments/navbar :: header}"></div>

<header class="catalog-header text-center">
  <div class="container">
    <h1 class="display-4 fw-bold"><i class="bi bi-book-half me-2"></i>Book Catalog</h1>
    <p class="lead">Explore our collection of stories and knowledge</p>
  </div>
</header>

<main class="container py-5">
  <div class="glass-card mb-4">
    <form th:action="@{/books}" th:object="${bookFilter}" method="get" class="row g-3">

      <div class="col-12">
        <div class="input-group input-group-lg shadow-sm">
          <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
          <input type="text" th:field="*{searchQuery}"
                 class="form-control border-start-0"
                 th:classappend="${#fields.hasErrors('searchQuery')} ? 'is-invalid'"
                 placeholder="Search by name, author, or description..."
                 onkeydown="if(event.key === 'Enter'){this.form.submit();}">
          <div class="invalid-feedback" th:if="${#fields.hasErrors('searchQuery')}" th:errors="*{searchQuery}"></div>
        </div>
      </div>

      <div class="col-md-3 filter-section">
        <label class="form-label small fw-bold">Author</label>
        <input type="text" th:field="*{author}" class="form-control shadow-sm"
               th:classappend="${#fields.hasErrors('author')} ? 'is-invalid'" placeholder="Author name">
        <div class="invalid-feedback" th:errors="*{author}"></div>
      </div>

      <div class="col-md-3 filter-section">
        <label class="form-label small fw-bold">Genre</label>
        <input type="text" th:field="*{genre}" class="form-control shadow-sm"
               th:classappend="${#fields.hasErrors('genre')} ? 'is-invalid'" placeholder="e.g. Fantasy">
        <div class="invalid-feedback" th:errors="*{genre}"></div>
      </div>

      <div class="col-md-3 filter-section">
        <label class="form-label small fw-bold">Age Group</label>
        <select th:field="*{ageGroup}" class="form-select shadow-sm" th:classappend="${#fields.hasErrors('ageGroup')} ? 'is-invalid'">
          <option value="">All Ages</option>
          <option th:each="age : ${ageGroups}" th:value="${age}" th:text="${age}"></option>
        </select>
        <div class="invalid-feedback" th:errors="*{ageGroup}"></div>
      </div>

      <div class="col-md-3 filter-section">
        <label class="form-label small fw-bold">Sort By</label>
        <select name="sort" class="form-select shadow-sm" onchange="this.form.submit()">
          <option value="name,asc"
                  th:selected="${param.sort != null and param.sort[0].equalsIgnoreCase('name,asc')}">
            Name (A-Z)
          </option>
          <option value="name,desc"
                  th:selected="${param.sort != null and param.sort[0].equalsIgnoreCase('name,desc')}">
            Name (Z-A)
          </option>
          <option value="price,asc"
                  th:selected="${param.sort != null and param.sort[0].equalsIgnoreCase('price,asc')}">
            Price (Low-High)
          </option>
          <option value="price,desc"
                  th:selected="${param.sort != null and param.sort[0].equalsIgnoreCase('price,desc')}">
            Price (High-Low)
          </option>
        </select>
      </div>

      <div class="col-md-6 d-flex gap-2">
        <div class="w-50 filter-section">
          <label class="form-label small fw-bold">Price Range</label>
          <div class="input-group input-group-sm">
            <input type="number" step="0.01" th:field="*{minPrice}"
                   class="form-control" th:classappend="${#fields.hasErrors('minPrice')} ? 'is-invalid'" placeholder="Min">
            <input type="number" step="0.01" th:field="*{maxPrice}"
                   class="form-control" th:classappend="${#fields.hasErrors('maxPrice')} ? 'is-invalid'" placeholder="Max">
          </div>
          <div class="text-danger extra-small mt-1" th:if="${#fields.hasErrors('minPrice')}" th:errors="*{minPrice}"></div>
          <div class="text-danger extra-small mt-1" th:if="${#fields.hasErrors('maxPrice')}" th:errors="*{maxPrice}"></div>
        </div>
        <div class="w-50 filter-section">
          <label class="form-label small fw-bold">Publication Period</label>
          <div class="input-group input-group-sm">
            <input type="date" th:field="*{startPublicationDate}"
                   class="form-control" th:classappend="${#fields.hasErrors('startPublicationDate')} ? 'is-invalid'">
            <input type="date" th:field="*{endPublicationDate}"
                   class="form-control" th:classappend="${#fields.hasErrors('endPublicationDate')} ? 'is-invalid'">
          </div>
          <div class="text-danger extra-small mt-1" th:if="${#fields.hasErrors('startPublicationDate')}" th:errors="*{startPublicationDate}"></div>
          <div class="text-danger extra-small mt-1" th:if="${#fields.hasErrors('endPublicationDate')}" th:errors="*{endPublicationDate}"></div>
        </div>
      </div>

      <div class="col-md-6 filter-section">
        <label class="d-block mb-2 small fw-bold">Languages</label>
        <div class="d-flex flex-wrap gap-3">
          <div class="form-check" th:each="lang : ${languages}">
            <input class="form-check-input" type="checkbox" th:field="*{languages}" th:value="${lang}" th:id="'lang-'+${lang}">
            <label class="form-check-label" th:for="'lang-'+${lang}" th:text="${lang}"></label>
          </div>
        </div>
        <div class="text-danger small" th:if="${#fields.hasErrors('languages')}" th:errors="*{languages}"></div>
      </div>

      <div class="col-12 mt-4 text-center">
        <button type="submit" class="btn btn-primary px-5 rounded-pill shadow">Apply Filters</button>
        <a th:href="@{/books}" class="btn btn-link text-decoration-none ms-3">Clear All</a>
      </div>
    </form>
  </div>

  <div class="glass-card">
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
        <tr>
          <th style="width: 25%">Book Title & Desc</th>
          <th>Author & Genre</th>
          <th>Publication</th>
          <th>Technical Specs</th>
          <th>Price</th>
          <th sec:authorize="hasRole('CLIENT')" class="text-center">Purchase</th>
          <th sec:authorize="hasAnyRole('EMPLOYEE', 'ADMIN')" class="text-end">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="book : ${bookPage.content}">
          <td>
            <div class="fw-bold text-dark h6 mb-1" th:text="${book.name}"></div>
            <div class="text-muted small text-truncate-2" th:title="${book.description}" th:text="${book.description}"></div>
          </td>
          <td>
            <div class="small fw-medium"><i class="bi bi-person-fill me-1 text-secondary"></i><span th:text="${book.author}"></span></div>
            <div class="badge bg-primary-subtle text-primary extra-small mt-1" th:text="${book.genre}"></div>
          </td>
          <td>
            <div class="small text-dark" th:text="${#temporals.format(book.publicationDate, 'MMM dd, yyyy')}"></div>
            <div class="text-uppercase extra-small fw-bold text-muted" th:text="${book.language}"></div>
          </td>
          <td>
            <div class="small"><i class="bi bi-file-earmark-text me-1"></i> <span th:text="${book.pages} + ' pages'"></span></div>
            <div class="small text-secondary"><i class="bi bi-people me-1"></i> <span th:text="${book.ageGroup}"></span></div>
            <div class="extra-small text-muted fst-italic mt-1" th:text="${book.characteristics}"></div>
          </td>
          <td>
            <span class="fw-bold text-primary" th:text="'$' + ${book.price}"></span>
          </td>
          <td sec:authorize="hasRole('CLIENT')" class="text-center">
                        <span th:if="${book.inCart}" class="badge rounded-pill bg-success p-2 px-3">
                            <i class="bi bi-cart-check-fill me-1"></i> In Cart
                        </span>
            <button th:unless="${book.inCart}"
                    class="btn btn-outline-primary btn-sm rounded-pill px-4 add-to-cart-btn"
                    th:data-uuid="${book.publicId}">
              Add to Cart
            </button>
          </td>
          <td sec:authorize="hasAnyRole('EMPLOYEE', 'ADMIN')" class="text-end">
            <div class="btn-group gap-2">
              <a th:href="@{/books/{uuid}/update(uuid=${book.publicId})}" class="btn btn-sm btn-light border shadow-sm">
                <i class="bi bi-pencil"></i>
              </a>
              <form th:action="@{/books/{uuid}/delete(uuid=${book.publicId})}" th:method="post" class="d-inline">
                <input type="hidden" name="page" th:value="${bookPage.number}"/>
                <input type="hidden" name="size" th:value="${bookPage.size}"/>
                <input type="hidden" name="sort" th:value="${param.sort}"/>
                <button type="submit" class="btn btn-sm btn-outline-danger shadow-sm"
                        onclick="return confirm('Are you sure you want to delete this book?')">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <nav th:if="${totalPages > 1}" class="mt-4">
      <ul class="pagination justify-content-center">
        <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
            class="page-item" th:classappend="${currentPage == i} ? 'active'">
          <a class="page-link shadow-sm"
             th:href="@{/books(page=${i}, searchQuery=${bookFilter.searchQuery}, author=${bookFilter.author}, genre=${bookFilter.genre}, ageGroup=${bookFilter.ageGroup}, minPrice=${bookFilter.minPrice}, maxPrice=${bookFilter.maxPrice}, startPublicationDate=${bookFilter.startPublicationDate}, endPublicationDate=${bookFilter.endPublicationDate}, languages=${bookFilter.languages}, sort=${param.sort})}"
             th:text="${i + 1}"></a>
        </li>
      </ul>
    </nav>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/catalog.js}"></script>

</body>
</html>