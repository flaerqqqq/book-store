<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <title>Book Catalog</title>
</head>
<body>
<h1>Book Catalog</h1>

<form th:action="@{/books}" th:object="${bookFilter}" method="get">
  <div>
    <label>Search:</label>
    <input type="text" th:field="*{searchQuery}"
           placeholder="Search by name, description, author..."
           onkeydown="if(event.key === 'Enter'){this.form.submit();}"/>
  </div>

  <div>
    <label>Author:</label>
    <input type="text" th:field="*{author}" />

    <label>Genre:</label>
    <input type="text" th:field="*{genre}" />

    <label>Age Group:</label>
    <select th:field="*{ageGroup}">
      <option value="">All</option>
      <option th:each="age : ${ageGroups}"
              th:value="${age}" th:text="${age}"></option>
    </select>
  </div>

  <div>
    <label>Price Min:</label>
    <input type="number" step="0.01" th:field="*{minPrice}" />
    <span th:if="${#fields.hasErrors('minPrice')}"
          th:errors="*{minPrice}"></span>

    <label>Max:</label>
    <input type="number" step="0.01" th:field="*{maxPrice}" />
    <span th:if="${#fields.hasErrors('maxPrice')}"
          th:errors="*{maxPrice}"></span>
  </div>

  <div>
    <label>Publication Date From:</label>
    <input type="date"
           th:name="startPublicationDate"
           th:value="${bookFilter.startPublicationDate != null ? #temporals.format(bookFilter.startPublicationDate, 'yyyy-MM-dd') : ''}" />
    <span th:if="${#fields.hasErrors('startPublicationDate')}"
          th:errors="*{startPublicationDate}"></span>

    <label>To:</label>
    <input type="date"
           th:name="endPublicationDate"
           th:value="${bookFilter.endPublicationDate != null ? #temporals.format(bookFilter.endPublicationDate, 'yyyy-MM-dd') : ''}" />
  </div>

  <div>
    <label>Languages:</label>
    <span th:each="lang : ${languages}">
      <input type="checkbox" th:field="*{languages}" th:value="${lang}" />
      <label th:text="${lang}"></label>
    </span>
  </div>

  <button type="submit">Apply Filters</button>
  <a th:href="@{/books}">Clear</a>

  <label>Sort By:</label>
  <select name="sort" onchange="this.form.submit()">
    <option value="name,asc" th:selected="${param.sort != null && param.sort[0] == 'name,asc'}">Name (A-Z)</option>
    <option value="name,desc" th:selected="${param.sort != null && param.sort[0] == 'name,desc'}">Name (Z-A)</option>
    <option value="price,asc" th:selected="${param.sort != null && param.sort[0] == 'price,asc'}">Price (Low-High)</option>
    <option value="price,desc" th:selected="${param.sort != null && param.sort[0] == 'price,desc'}">Price (High-Low)</option>
  </select>
</form>
<br/>
<table border="1">
  <thead>
  <tr>
    <th>Name</th>
    <th>Author</th>
    <th>Price</th>
    <th>Language</th>
    <th sec:authorize="hasRole('CLIENT')">Purchase</th>
    <th sec:authorize="hasAnyRole('EMPLOYEE', 'ADMIN')">Actions</th>
  </tr>
  </thead>
  <tbody>
  <tr th:each="book : ${bookPage.content}">
    <td th:text="${book.name}">Name</td>
    <td th:text="${book.author}">Author</td>
    <td th:text="${book.price}">0.00</td>
    <td th:text="${book.language}">English</td>
    <td sec:authorize="hasRole('CLIENT')">
      <span th:if="${book.inCart}" style="color: green; font-weight: bold;">
        In Cart ✅
      </span>

      <button th:unless="${book.inCart}"
              type="button"
              class="add-to-cart-btn"
              th:data-uuid="${book.publicId}">
        Add to Cart
      </button>
    </td>    <td sec:authorize="hasAnyRole('EMPLOYEE', 'ADMIN')">
      <a th:href="@{/books/{uuid}/update(uuid=${book.publicId})}">
        <button type="button">Update</button>
      </a>
      <form th:action="@{/books/{uuid}/delete(uuid=${book.publicId})}" th:method="post">
        <input type="hidden" name="page" th:value="${bookPage.number}"/>
        <input type="hidden" name="size" th:value="${bookPage.size}"/>
        <input type="hidden" name="sort" th:value="${param.sort}"/>
        <button type="submit">Delete</button>
      </form>
    </td>
  </tr>
  </tbody>
</table>

<div th:if="${totalPages > 1}">
  <hr/>
  <span>Pages: </span>

  <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
            <a th:if="${currentPage != i}"
               th:href="@{/books(page=${i},
                         author=${bookFilter.author},
                         genre=${bookFilter.genre},
                         ageGroup=${bookFilter.ageGroup},
                         minPrice=${bookFilter.minPrice},
                         maxPrice=${bookFilter.maxPrice},
                         startPublicationDate=${bookFilter.startPublicationDate},
                         endPublicationDate=${bookFilter.endPublicationDate},
                         languages=${bookFilter.languages},
                         searchQuery=${bookFilter.searchQuery})}"
               th:text="${i + 1}"></a>
            <span th:if="${currentPage == i}" th:text="${i + 1}" style="font-weight: bold;"></span>
            &nbsp;
        </span>
</div>
<br/>
<div sec:authorize="hasAnyRole('EMPLOYEE', 'ADMIN')">
  <a th:href="@{/books/new}">Add New Book</a>
</div>
<div sec:authorize="hasRole('CLIENT')">
  <a th:href="@{/shopping-cart}">Go to Shopping Cart</a>
</div>
<script>
  document.querySelectorAll('.add-to-cart-btn').forEach(button => {
    button.addEventListener('click', function() {
      const bookUuid = this.getAttribute('data-uuid');
      const btn = this;

      fetch('/api/shopping-carts/items', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ bookPublicId: bookUuid })
      })
              .then(response => {
                if (response.ok) {
                  btn.innerText = "Added! ✅";
                  btn.style.backgroundColor = "#d4edda";
                  btn.disabled = true;
                } else {
                  alert("Could not add book. Please try again.");
                }
              })
              .catch(error => console.error('Error:', error));
    });
  });
</script>
</body>
</html>